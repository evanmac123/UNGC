<%# workaround for two tree view plugin issues %>
<script type="text/javascript" charset="utf-8" src='/javascripts/jquery.tree.js'></script>
<% if true %>
<script>

var selected = null;
$(function () { 
	$("#tree").tree({
     ui: {
       dots: false,
       theme_name: 'apple'
     },
		data : { 
			type : "json",
			opts : {
				url : "/admin/pages.js"
			}
		},
		types: {
		  'page': {
		    'icon': {
		      'image': '/images/page_white.png'
		    }
		  },
		  'section': {
		    'icon': {
		      'image': '/images/folder.png'
		    }
		  }
		},
    callback: {
      check_move: function(node, ref_node, type, tree_obj) {
        var ref_type = tree_obj.get_type(ref_node);
        var node_type = tree_obj.get_type(node);
        if (node_type == 'page') {
          if (ref_type == 'section' && type != 'inside')
            return false;
        } else if (node_type == 'section') {
          if (type == 'inside' || ref_type == 'page')
            return false;
        }
      },
      ondblclk: function(node, tree) {
        $.tree.focused().rename();
        // console.log("double clicked dood!");
      },
      oncreate: function(node, ref_node, type, tree_obj, rollback) {
        if ($(node).attr('rel') != 'section') {
          saveNewPagePlaceholder(node, ref_node, type, tree_obj, rollback);
        }
      },
      onrename: function(node, tree, rollback) {
        if ($(node).hasClass('updateAfterRename')) {
          var id = $(node).attr('id').match(/(\d+)/)[1];
          var title = tree.get_text(node);
          var url = window.location.href + '/' + id + '/rename.js'
          jQuery.ajax({
            type: 'post',
            url: url,
            dataType: 'json',
            data: "&title="+title,
            complete: function(response) { 
              $(node).removeClass('updateAfterRename');
              tree.select_branch(node);
            }
          });
        }
      },
      onselect: function(node, tree) {
        if (selected != node) {
          selected = node; // FIXME: global variables might be evil
          var url = $(node).children('a').attr('href');
          if (url != '') {
            $('#loading').show();
            url += '.js';
            jQuery.ajax({
              type: 'get',
              url: url,
              dataType: 'script',
              success: showPage
            });
          }
        }
      }
     }
	});
});


</script>
<% end %>