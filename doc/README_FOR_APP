United Nations Global Compact
=============================

Accounts
========

OpenCms
-------
OpenCms login
http://66.109.24.102:8080/opencms2/opencms/system/login/index.html
unspace:unspacecms

Administration section
----------------------
http://demo.unglobalcompact.org/
Administrator - unspace:unspace
Participant   - logo:request

Hoptoad
-------
http://unspaceungc.hoptoadapp.com/
user: cloves@unspace.ca
password: hoptoad

NewRelic RPM
------------
URL: https://rpm.newrelic.com
user: ungc@unspace.ca
password: newrelic

App
---
organization user: ungc341 / FE2EC4C8
admin user: keesari / compact2



Data Migration
==============

We created two classes in the lib/ folder - Importer and HabtmImporter - that populate the database in our format from UNGC data - uses the .CSV files located in lib/un7_tables by default.

If you want to import from a more recent set of files, open Enterprise Manager in demo.unglobalcompact.org, and run the "Unicode Export" DTS in UNGC2. Then, copy the export files - Desktop/unicode export - to the lib/un7_tables folder in your project folder. After copying the new files TXT files, run the following command to properly convert them to UTF-8 encoded .CSV files:
> ./script/convert_to_utf8 lib/un7_tables/*.txt

To import the data from the .CSV files, go to a console and run:
>> Importer.new.run

(You can also use runner: ./script/runner "Importer.new.run")

Be patient, a run will take close to 1 hour - or more :)

To import CMS content, install the Hpricot gem - gem install hpricot - and run these two scripts from a command prompt:
> ./script/import
> ./script/replace

> rake db:drop db:create && rake db:migrate && ./script/runner "Importer.new.run" && ./script/import && ./script/replace

Some COP files not imported, individual files can be imported with:
cop.cop_files.create(:attachment => File.new('/home/rails/ungc/uploaded/cops/2D2301B3-7B72-40F5-98EE-E0F30463D843/COP.doc'), :attachment_type => CopFile::TYPES[:cop])


Application setup
=================

Make sure you run Ruby 1.9.1!
rvm - http://rvm.beginrescueend.com/ - makes installing multiple Ruby versions extremely easy.

sudo gem install rvm
rvm-install
rvm use 1.9.1 - this will download and install ruby 1.9.1
rvm 1.9.1 --default - this will make the downloaded 1.9.1 the default in your computer
At this point, you get new executables for gem, irb and ruby, and have to install all gems again.
Make sure you never run the "sudo" command before installing any of the gems.

If you are setting up this application for the first time in you machine, follow the steps below:

cp config/database.yml.sample config/database.yml
rake gems:install
rake db:create
rake db:migrate
rake db:seed
./script/server

Search requires:
- the Sphinx search engine, install version 0.9.9 from source:
http://freelancing-god.github.com/ts/en/installing_sphinx.html
- the Python library 'pdfminer', see this page for installation instructions:
http://www.unixuser.org/~euske/python/pdfminer/index.html

Make sure that pdf2txt.py is in the path, and it should be fine.

Done :)

Controlling Sphinx
==================

rake ts:rebuild
rake ts:start

Deploy with Capistrano
======================

cap -T
cap deploy

Cron Jobs
=========

The application needs a cron job to notify organizations of their COP submission deadline - this needs to run daily.
./script/runner 'CopReminder.new.notify_all' RAILS_ENV=production

The application needs a cron job to update organizations' COP state - this needs to run daily.
./script/runner 'CopStatusUpdater.new.update_all' RAILS_ENV=production

Fields to delete
================

Here's a list of tables/fields that should be safe to delete after the application has been launched:

*.old_id - only used by importer
case_stories.status - using state
case_stories.case_date - using updated_at

communication_on_progresses.facilitator - never used
communication_on_progresses.status - using state
communication_on_progresses.start_year - using starts_on
communication_on_progresses.start_month - using starts_on
communication_on_progresses.end_year - using ends_on
communication_on_progresses.end_month - using ends_on

contacts.advisory_council - legacy column was never used
contacts.ceo - roles replace the use of this field
contacts.contact_point - roles replace the use of this field
contacts.newsletter - roles replace the use of this field
country.manager_id - used in transition, not used anymore

logo_requests.status - using state
logo_requests.requested_on - using created_at
logo_requests.status_changed_on - using updated_at

organizations.cop_status - using cop_state
organizations.local_network - we have a new LocalNetwork model
organizations.old_tmp_id - only used by importer
organizations.status - using state
pages.top_level - only used by importer

Server Backup
=============
To upgrade current version of JungleDisk
sudo kill 'current process id'
curl -O http://downloads.jungledisk.com/jungledisk/junglediskserver_308-0_amd64.deb
sudo dpkg -i junglediskserver_308-0_amd64.deb

Server should start, if not: 
sudo /usr/local/bin/junglediskserver