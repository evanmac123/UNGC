United Nations Global Compact
=============================

Accounts
========

Hoptoad
-------
http://unspaceungc.hoptoadapp.com/
user: jamie@unspace.ca
password: hoptoad

NewRelic RPM
------------
URL: https://rpm.newrelic.com
user: ungc@unspace.ca
password: newrelic

App
---
organization user: ungc341 / FE2EC4C8
admin user: keesari / compact2


Data Migration
==============

To import the CMS data you need to get a recent dump of the production database.  This can be done by SSHing into the production server at:  rails@unglobalcompact.railsmachina.com.  You'll need to get someone who already has access to add your ssh public key to the authorized_keys file on the server.  Create a dump of the production database using mysqldump and then SCP that dump file over to your localhost.  Import that and you're good to go.  

Application setup
=================

Make sure you run Ruby 1.9.1!
rvm - http://rvm.beginrescueend.com/ - makes installing multiple Ruby versions extremely easy.

sudo gem install rvm
rvm-install
rvm use 1.9.1 - this will download and install ruby 1.9.1
rvm 1.9.1 --default - this will make the downloaded 1.9.1 the default in your computer
At this point, you get new executables for gem, irb and ruby, and have to install all gems again.
Make sure you never run the "sudo" command before installing any of the gems.

If you are setting up this application for the first time in you machine, follow the steps below:

cp config/database.yml.sample config/database.yml
rake gems:install
rake db:create
rake db:migrate
rake db:seed
./script/server

Search requires:
- the Sphinx search engine, install version 0.9.9 from source:
http://freelancing-god.github.com/ts/en/installing_sphinx.html
- the Python library 'pdfminer', see this page for installation instructions:
http://www.unixuser.org/~euske/python/pdfminer/index.html

Make sure that pdf2txt.py is in the path, and it should be fine.

Done :)

Debugger
========
script/server --debugger
place 'debugger' at your breakpoint
press 'c' to continue execution

Controlling Sphinx
==================

rake ts:rebuild
rake ts:start

Deploy with Capistrano
======================

cap -T
cap deploy

Cron Jobs
=========

The application needs a cron job to notify organizations of their COP submission deadline - this needs to run daily.
./script/runner 'CopReminder.new.notify_all' RAILS_ENV=production

The application needs a cron job to update organizations' COP state - this needs to run daily.
./script/runner 'CopStatusUpdater.new.update_all' RAILS_ENV=production

COP Maintenance
===============
cop.cop_links.create(:url => 'http://www.ahkbrasil.com/download/CSR_RelatorioAnualAHK_2009_10.pdf', :attachment_type => 'cop', :language_id => 19)

Adding a new Report
===================

Follow these steps while referring to existing reports:

1) Add your report query to app/reports as a type of SimpleReport
2) Add corresponding method to controllers/admin/reports_controller.rb
3) Optional: add a view for your report in app/views/admin/reports
4) Add the report to the reports index screen app/views/admin/report/index.html.haml

Fields to delete
================

Here's a list of tables/fields that should be safe to delete after the application has been launched:

*.old_id - only used by importer
case_stories.status - using state
case_stories.case_date - using updated_at

communication_on_progresses.facilitator - never used
communication_on_progresses.status - using state
communication_on_progresses.start_year - using starts_on
communication_on_progresses.start_month - using starts_on
communication_on_progresses.end_year - using ends_on
communication_on_progresses.end_month - using ends_on

contacts.advisory_council - legacy column was never used
contacts.ceo - roles replace the use of this field
contacts.contact_point - roles replace the use of this field
contacts.newsletter - roles replace the use of this field
country.manager_id - used in transition, not used anymore

logo_requests.status - using state
logo_requests.requested_on - using created_at
logo_requests.status_changed_on - using updated_at

organizations.local_network - we have a new LocalNetwork model
organizations.old_tmp_id - only used by importer
organizations.status - using state
pages.top_level - only used by importer

Server Backup
=============
To upgrade current version of JungleDisk
sudo kill 'current process id'
curl -O http://downloads.jungledisk.com/jungledisk/junglediskserver_308-0_amd64.deb
sudo dpkg -i junglediskserver_308-0_amd64.deb

Server should start, if not: 
sudo /usr/local/bin/junglediskserver