cap staging deploy
United Nations Global Compact
=============================

Accounts
========

Hoptoad
-------
http://unspaceungc.hoptoadapp.com/
user: jamie@unspace.ca
password: hoptoad

NewRelic RPM
------------
URL: https://rpm.newrelic.com
user: ungc@unspace.ca
password: newrelic

App
---
organization user: ungc341 / FE2EC4C8
admin user: keesari / compact2


Data Migration
==============

Firstly, you will want to make sure that you have all the required plugins.  This can be accomplished with the following commands:

rake gems:install
git submodule init
git submodule update

Secondly, the data from the current production database can be imported by taking a dump of the production database using the mysqldump command. You'll need to get access to the machine running the production application. This can be done by SSHing to rails@unglobalcompact.railsmachina.com. You will need to get your public SSH key added to the ~/.ssh/authorized_keys file for the rails user on unglobalcompact.railsmachina.com. Once you have access use the mysqldump command to get a snapshot of the current production database.  Copy this file to your machine using scp. 

Make sure your database is using the correct encoding:
  mysql -u root -e CREATE DATABASE unglobalcompact CHARACTER SET utf8 COLLATE utf8_general_ci;

Once you have the database dump import it into your development database using:
  mysql -D <database> < production_dumpfile.sql

Application setup
=================

Make sure you run Ruby 1.9.1!
rvm - http://rvm.beginrescueend.com/ - makes installing multiple Ruby versions extremely easy.

sudo gem install rvm
rvm-install
rvm use 1.9.1 - this will download and install ruby 1.9.1
rvm 1.9.1 --default - this will make the downloaded 1.9.1 the default in your computer
At this point, you get new executables for gem, irb and ruby, and have to install all gems again.
Make sure you never run the "sudo" command before installing any of the gems.

If you are setting up this application for the first time in you machine, follow the steps below:

cp config/database.yml.sample config/database.yml
rake gems:install
rake db:create
rake db:migrate
rake db:seed
./script/server

Search requires:
- the Sphinx search engine, install version 0.9.9 from source:
http://freelancing-god.github.com/ts/en/installing_sphinx.html
- the Python library 'pdfminer', see this page for installation instructions:
http://www.unixuser.org/~euske/python/pdfminer/index.html

Make sure that pdf2txt.py is in the path, and it should be fine.

Done :)

Debugger
========
script/server --debugger
place 'debugger' at your breakpoint
press 'c' to continue execution

Controlling Sphinx
==================

rake ts:rebuild
rake ts:start

Deploy with Capistrano
======================

cap -T
-- choose which branch to deploy from
cap staging deploy
-- deploys from production branch
cap production deploy 

Cron Jobs
=========

The application needs a cron job to notify organizations of their COP submission deadline - this needs to run daily.
./script/runner 'CopReminder.new.notify_all' RAILS_ENV=production

The application needs a cron job to update organizations' COP state - this needs to run daily.
./script/runner 'CopStatusUpdater.new.update_all' RAILS_ENV=production

COP Maintenance
===============
cop.cop_links.create(:url => 'http://www.ahkbrasil.com/', :attachment_type => 'cop', :language_id => 19)

cop.cop_files.create(:attachment => File.new('/home/rails/ungc/uploaded/cops/COP.pdf'), :attachment_type => CopFile::TYPES[:cop], :language_id => 4)



Adding a new Report
===================

Follow these steps while referring to existing reports:

1) Add your report query to app/reports as a type of SimpleReport
2) Add corresponding method to controllers/admin/reports_controller.rb
3) Optional: add a view for your report in app/views/admin/reports
4) Add the report to the reports index screen app/views/admin/report/index.html.haml

Fields to delete
================

Here's a list of tables/fields that should be safe to delete after the application has been launched:

*.old_id - only used by importer
case_stories.status - using state
case_stories.case_date - using updated_at

communication_on_progresses.facilitator - never used
communication_on_progresses.status - using state
communication_on_progresses.start_year - using starts_on
communication_on_progresses.start_month - using starts_on
communication_on_progresses.end_year - using ends_on
communication_on_progresses.end_month - using ends_on

contacts.advisory_council - legacy column was never used
contacts.ceo - roles replace the use of this field
contacts.contact_point - roles replace the use of this field
contacts.newsletter - roles replace the use of this field

country.manager_id - used in transition, not used anymore

logo_requests.status - using state
logo_requests.requested_on - using created_at
logo_requests.status_changed_on - using updated_at

organizations.local_network - we have a new LocalNetwork model
organizations.added_on - may want to transfer to created_at
organizations.modified_on - may want to transfer to updated_at

pages.top_level - only used by importer

Server Backup
=============
To upgrade current version of JungleDisk
sudo kill 'current process id'
curl -O http://downloads.jungledisk.com/jungledisk/junglediskserver_308-0_amd64.deb
sudo dpkg -i junglediskserver_308-0_amd64.deb

Server should start, if not: 
sudo /usr/local/bin/junglediskserver