#!/usr/bin/env ruby
require File.dirname(__FILE__) + '/../config/environment' unless defined?(RAILS_ROOT)
require 'hpricot'
require 'facets'
require 'pp'

root = '/Users/joshua/Sites/unspace/demo.unglobalcompact.org/'
def Dir.stuff(path)
  not_stuff = ['.', '..', '.DS_Store']
  entries(path) - not_stuff
end

def get_files_from(path, files=[])
  Dir.stuff(path).each do |name|
    fullname = File.join(path, name)
    files << fullname if name =~ /\.html$/ unless name =~ /^search_participant/
    if File.directory?(fullname)
      files += get_files_from(fullname)
    end
  end
  return files
end

files = get_files_from(root)

files.each do |filename|
  # filename = files.rand
  # filename = '/Users/joshua/Sites/unspace/demo.unglobalcompact.org/NewsAndEvents/speeches_and_statements/dsg_statement_russian_business_community.html'
  # insides = File.read(filename)
  # insides.gsub!(/<(\/?[A-Z0-9]+)/) { |s| "<#{$1.downcase}" }
  doc = Hpricot(open(filename))
  content = (doc/'#content_inner .copy p')
  content = (content.first || content).inner_html.strip
  path = []
  (doc/'#rightcontent .path p a').each do |elem|
    path << { elem.attributes['href'] => elem.inner_html }
  end
  puts "Reading from '#{filename}'"
  # pp content
  Content.create :path => filename - root, :crumbs => path, :content => content  
end
