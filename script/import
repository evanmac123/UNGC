#!/usr/bin/env ruby
ENV['RAILS_ENV'] = ARGV.first || ENV['RAILS_ENV'] || 'development'  
require File.dirname(__FILE__) + '/../config/environment' unless defined?(RAILS_ROOT)
require 'hpricot'
require 'pp'
require 'facets'
require 'import_helper'

SHORTS = {
  'Human Rights' => 'human_rights',
  'Labour' => 'labour',
  'Environment' => 'environment',
  'Anti-Corruption' => 'anti_corruption',
  'Business and Peace' => 'business_peace',
  'Financial Markets' => 'financial',
  'Partnerships for Development' => 'partnerships',
  'UN/Business Partnerships' => 'un_business'
}

# root = '/Users/joshua/Sites/unspace/demo.unglobalcompact.org/'
root = '/Users/joshua/Sites/unspace/opencms_export/unglobalcompact/'

Navigation.delete_all
filename = root + 'index.html'
$doc = Hpricot(open(filename))
parse_language_nav(root)
parse_sitenav_nav(root)
($doc/'div#nav > ul > li').inject(0) do |i, elem|
  attrs = attributes_for_element elem
  children = attrs.delete(:children)
  attrs[:position] = i
  parent = Navigation.create attrs
  children.inject(0) do |j, child|
    short = attrs[:label] == 'Issues' ? SHORTS[child[:label]] : ''
    Navigation.create child.merge(:parent_id => parent.id, :position => j, :short => short)
    j += 1
  end
  i += 1
end

Content.delete_all
files = get_files_from(root)
files.each do |filename|
  puts "Reading from '#{filename - root}'"
  # filename = root + 'index.html'
  doc = Hpricot(open(filename))
  if filename == (root + 'index.html')
    content = home_page_content(doc)
  else
    content = regular_page_content(doc) # will also create sub-level leftnav
  end
  # pp content
  path = "/#{filename - root}"
  content = Content.create :content => content, :path => path
  # Navigation.find_all_by_href(path).each do |nav|
  #   nav.update_attribute(:content_id, content.id)
  # end
end

# fix some weird banner issues
Navigation.find_by_label('The CEO Water Mandate').update_attribute(:short, 'environment_ceo')
Navigation.find_by_label('Caring for Climate').update_attribute(:short, 'environment_c4c')
