#!/usr/bin/env ruby
# encoding: utf-8
ENV['RAILS_ENV'] = ARGV.first || ENV['RAILS_ENV'] || 'development'  
require File.dirname(__FILE__) + '/../config/environment' unless defined?(RAILS_ROOT)
require 'hpricot'
require 'pp'
require 'facets'
require 'import_helper'
begin
  require 'ruby-debug' if Rails.env == 'development'
rescue LoadError => e
  puts "*** ERROR: Please run 'gem install ruby-debug19'"
  raise "unable to load"
end

# Abbreviate long section names, so we can use them as CSS selectors
CODES = {
  'Human Rights' => 'human_rights',
  'Labour' => 'labour',
  'Environment' => 'environment',
  'Anti-Corruption' => 'anti_corruption',
  'Business and Peace' => 'business_peace',
  'Financial Markets' => 'financial',
  'Partnerships for Development' => 'partnerships',
  'UN/Business Partnerships' => 'un_business'
}

MOVED_PAGES = {
  '/NewsAndEvents/upcoming_events.html' => '/NewsAndEvents/2008_events.html',
  '/NewsAndEvents/upcoming_events_2009.html' => '/NewsAndEvents/2009_events.html',
  '/WebsiteInfo/search_global_compact.html' => '/search'
}

# Points to the unglobalcompact directory of the CMS export
root = "#{RAILS_ROOT}/vendor/open_cms_export/unglobalcompact/"

Page.delete_all; PageGroup.delete_all # reset to 0
parse_language_nav(root)              # Language pages have their own navigation that isn't well integrated
parse_sitenav_nav(root)               # Likewise, the 'WebsiteInfo' section - contact us, etc.
parse_regular_nav(root)               # For everything else

files = get_files_from(root)
# files = [root + 'Languages/spanish/gp_full_spanish.html']

update_these_pages_at_end = []
files.each do |filename|
  puts "Reading from '#{filename - root}'" # if filename =~ /meetings/i
  possible = read_and_write_content(root, filename)
  update_these_pages_at_end << possible if possible
end

update_navigation_info(update_these_pages_at_end)
manually_adjust_shorts 